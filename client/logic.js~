var initApp = function() {

window.addEventListener("load", function(event) {

/** VARIABLES **/

	var ctx;
	var speed = 20;

	var WIDTH = 500;
	var HEIGHT = 500;

	var socket;

	var coord = {x: 50, y: 50};
	var serverCoord = [2,3];

	/** FUNCTIONS **/

	function Iniciar() {

		ctx = document.getElementById("canvas").getContext("2d");

		$("#hostInput").val("ws://localhost:5000");

		registerHtmlCallbacks();

		return setInterval(Atualizar, 20);
	}

	function Desenhar() {

		$("#x").html("X: " + coord.x);
		$("#y").html("Y: " + coord.y);
	  
		ctx.beginPath();
		ctx.fillStyle = "red";
		ctx.arc(coord.x, coord.y, 10, 0, Math.PI*2, true);
		ctx.fill();

		$("#info").html("info: " + serverCoord);

		for(var i =0; i < serverCoord.length; i++) {
			ctx.beginPath();
			ctx.fillStyle = "red";
			ctx.arc(JSON.parse(serverCoord[i]).x, JSON.parse(serverCoord[i]).y,10, 0, Math.PI*2, true);
			ctx.fill();
		}

	}

	function LimparTela() {
		ctx.fillStyle = "white";
		ctx.strokeStyle = "black";
		ctx.beginPath();
		ctx.rect(0, 0, WIDTH, HEIGHT);
		ctx.closePath();
		ctx.fill();
		ctx.stroke();
	}

	function Atualizar() {
		LimparTela();    
		Desenhar();
	}

	function KeyDown(evt){
		switch (evt.keyCode) {
		    case 38:  /*seta para cima */
		        if (coord.y - speed > 0){
		            coord.y -= speed;
		        }
		        break;
		    case 40:  /*set para baixo*/
		        if (coord.y + speed < HEIGHT){
		            coord.y += speed;
		        }
		        break;
		    case 37:  /*set para esquerda*/
		        if (coord.x - speed > 0){
		            coord.x -= speed;
		        }
		        break;
		    case 39:  /*seta para direita*/
		        if (coord.x + speed < WIDTH){
		            coord.x += speed;
		        }
		        break;
		}

		socket.send(JSON.stringify(coord));
	}

	/** REGISTER CALLBACKS **/

	function registerHtmlCallbacks() {

	   $("#connectButton").click(function() {
	   		socket = new WebSocket($("#hostInput").val(), "echo-protocol");
			registerSocketCallbacks();
	   });

		window.addEventListener('keydown', KeyDown, true);
	}

	function registerSocketCallbacks() {

		socket.addEventListener("open", function(event) {
		      $("#status").html("Connected!");
		 });

		socket.addEventListener("message", function(event) {
			var messagejson = JSON.parse(event.data);

		//	coord.x = serverCoord.x;
		//	coord.y = serverCoord.y;

			serverCoord = messagejson.slice(0);		

		});

		socket.addEventListener("error", function(err) {
			 $("#status").html("Not connected - HOST INVALID!");	
		});

		socket.addEventListener("close", function(err) {
			 $("#status").html("Not connected - CLOSED CONNECTION!");	
		});
	}  

	/** START THE FUNCTION**/

	Iniciar();

});
};

initApp();
